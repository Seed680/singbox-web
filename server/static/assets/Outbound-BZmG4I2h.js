import{r as S,k as N,l as le,o as oe,a as te,c as V,b as y,w as o,E as d,d as u,m as ae,e as c,f as l,n as B,u as _,p as A,q as F,g as b,s as q,t as E,j as re,h as ne,i as se,F as de,x as ie,y as I}from"./index-D0h7X9x_.js";import{_ as ue,P as fe}from"./PageContainer-BIDKZJWI.js";import"./globalConfig-CAtujKGB.js";import{J as ce}from"./jsoneditor-DKimo5TI.js";const me={class:"outbound"},pe={class:"card-header"},be={class:"card-header"},_e={class:"card-header"},ge={id:"extraOutboundsEditor",style:{width:"100%",height:"400px"}},ve={class:"dialog-footer"},w="/api",ye={__name:"Outbound",setup(we){const g=S(null),t=N({config:!1,subscription:!1,filter:!1,extraOutbounds:!1,delete:!1}),k=S([]),$=S([]),s=N({visible:!1,isEdit:!1,form:{name:"",url:"",lastUpdate:""}}),n=N({visible:!1,isEdit:!1,form:{name:"",include:"",exclude:"",allNodes:!0,node:"",mode:"select"}}),L=le(()=>k.value.map(a=>({label:a.name,value:a.name}))),M=()=>{const a=document.getElementById("extraOutboundsEditor"),e={mode:"code",modes:["code","tree","view","form","text"],onError:function(i){d.error("JSON 格式错误："+i.toString())},mainMenuBar:!0,navigationBar:!1,statusBar:!0,colorPicker:!1,search:!0,format:!0,repair:!0};g.value=new ce(a,e)},v=async()=>{try{t.config=!0;const a=await fetch(`${w}/config`);if(a.ok){const e=await a.json();if(k.value=e.subscribe.subscriptions||[],$.value=e.subscribe.filters||[],g.value){const i=e.subscribe.ex_outbounds||[];g.value.set(i)}}else d.error("加载配置失败")}catch(a){console.error("加载配置失败:",a),d.error("加载配置失败，请检查后端服务是否启动")}finally{t.config=!1}},R=()=>{s.visible=!0,s.isEdit=!1,s.form={name:"",url:"",lastUpdate:""}},z=a=>{s.visible=!0,s.isEdit=!0,s.form={name:a.name,url:a.url,lastUpdate:a.lastUpdate}},G=async a=>{try{await I.confirm("确定要删除该订阅吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),t.delete=!0;const e=await fetch(`${w}/subscription/${encodeURIComponent(a.name)}`,{method:"DELETE"});if(e.ok)d.success("删除成功"),await v();else{const i=await e.json();d.error(i.error||"删除失败")}}catch(e){e!=="cancel"&&(console.error("删除订阅失败:",e),d.error("删除失败"))}finally{t.delete=!1}},H=async()=>{if(!s.form.name||!s.form.url){d.warning("请填写名称和URL");return}try{t.subscription=!0;const a=await fetch(`${w}/subscription`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s.form.name,url:s.form.url,lastUpdate:s.form.lastUpdate})});if(a.ok)d.success(s.isEdit?"编辑成功":"添加成功"),s.visible=!1,await v();else{const e=await a.json();d.error(e.error||"保存失败")}}catch(a){console.error("保存订阅失败:",a),d.error("保存失败")}finally{t.subscription=!1}},K=()=>{n.visible=!0,n.isEdit=!1,n.form={name:"",include:"",exclude:"",allNodes:!0,node:"",mode:"select"}},Q=a=>{n.visible=!0,n.isEdit=!0,n.form={...a}},W=async a=>{try{await I.confirm("确定要删除该过滤器吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),t.delete=!0;const e=await fetch(`${w}/filter/${encodeURIComponent(a.name)}`,{method:"DELETE"});if(e.ok)d.success("删除成功"),await v();else{const i=await e.json();d.error(i.error||"删除失败")}}catch(e){e!=="cancel"&&(console.error("删除过滤器失败:",e),d.error("删除失败"))}finally{t.delete=!1}},X=async()=>{if(!n.form.name||!n.form.mode){d.warning("请填写名称和模式");return}if(!n.form.allNodes&&!n.form.node){d.warning("请选择节点");return}try{t.filter=!0,console.log("正在保存过滤器:",n.form);const a=await fetch(`${w}/filter`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n.form)}),e=await a.json();a.ok?(d.success(n.isEdit?"编辑成功":"添加成功"),n.visible=!1,await v()):(console.error("保存过滤器失败:",e),d.error(e.error||"保存失败"))}catch(a){console.error("保存过滤器异常:",a),d.error(`保存失败: ${a.message}`)}finally{t.filter=!1}},Y=async()=>{try{t.extraOutbounds=!0;const a=g.value.get();if(!Array.isArray(a)){d.error("额外出站必须是一个 JSON 数组");return}const e=await fetch(`${w}/extra-outbounds`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(e.ok)d.success("额外出站配置保存成功"),await v();else{const i=await e.json();d.error(i.error||"保存失败")}}catch(a){console.error("保存额外出站配置失败:",a),d.error("保存失败，请检查后端服务是否启动")}finally{t.extraOutbounds=!1}};return oe(()=>{M(),setTimeout(()=>{v()},100)}),te(()=>{g.value&&g.value.destroy()}),(a,e)=>{const i=u("el-icon"),f=u("el-button"),m=u("el-table-column"),T=u("el-button-group"),j=u("el-table"),h=u("el-card"),Z=u("el-tag"),x=u("el-input"),p=u("el-form-item"),D=u("el-form"),J=u("el-dialog"),ee=u("el-switch"),C=u("el-option"),P=u("el-select"),O=ae("loading");return y(),V(fe,null,{default:o(()=>[c("div",me,[e[19]||(e[19]=c("div",{class:"page-header"},[c("h2",{class:"page-title"},"出站配置")],-1)),l(h,{class:"box-card"},{header:o(()=>[c("div",pe,[e[13]||(e[13]=c("span",null,"订阅",-1)),l(f,{type:"primary",onClick:R,loading:t.subscription},{default:o(()=>[l(i,null,{default:o(()=>[l(_(q))]),_:1}),e[12]||(e[12]=b(" 添加订阅 "))]),_:1,__:[12]},8,["loading"])])]),default:o(()=>[B((y(),V(j,{data:k.value,style:{width:"100%"}},{default:o(()=>[l(m,{prop:"name",label:"名称"}),l(m,{prop:"url",label:"链接","show-overflow-tooltip":""}),l(m,{label:"操作",width:"200"},{default:o(({row:r})=>[l(T,null,{default:o(()=>[l(f,{type:"primary",onClick:U=>z(r),loading:t.subscription,disabled:t.subscription},{default:o(()=>[l(i,null,{default:o(()=>[l(_(A))]),_:1})]),_:2},1032,["onClick","loading","disabled"]),l(f,{type:"danger",onClick:U=>G(r),loading:t.delete,disabled:t.delete},{default:o(()=>[l(i,null,{default:o(()=>[l(_(F))]),_:1})]),_:2},1032,["onClick","loading","disabled"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[O,t.config]])]),_:1}),l(h,{class:"box-card"},{header:o(()=>[c("div",be,[e[15]||(e[15]=c("span",null,"过滤器",-1)),l(f,{type:"primary",onClick:K,loading:t.filter},{default:o(()=>[l(i,null,{default:o(()=>[l(_(q))]),_:1}),e[14]||(e[14]=b(" 添加过滤器 "))]),_:1,__:[14]},8,["loading"])])]),default:o(()=>[B((y(),V(j,{data:$.value,style:{width:"100%"}},{default:o(()=>[l(m,{prop:"name",label:"名称"}),l(m,{prop:"include",label:"包含关键字","show-overflow-tooltip":""}),l(m,{prop:"exclude",label:"排除关键字","show-overflow-tooltip":""}),l(m,{prop:"mode",label:"模式"},{default:o(({row:r})=>[l(Z,{type:r.mode==="select"?"success":"warning"},{default:o(()=>[b(E(r.mode==="select"?"节点选择":"速度测试"),1)]),_:2},1032,["type"])]),_:1}),l(m,{label:"操作",width:"200"},{default:o(({row:r})=>[l(T,null,{default:o(()=>[l(f,{type:"primary",onClick:U=>Q(r),loading:t.filter,disabled:t.filter},{default:o(()=>[l(i,null,{default:o(()=>[l(_(A))]),_:1})]),_:2},1032,["onClick","loading","disabled"]),l(f,{type:"danger",onClick:U=>W(r),loading:t.delete,disabled:t.delete},{default:o(()=>[l(i,null,{default:o(()=>[l(_(F))]),_:1})]),_:2},1032,["onClick","loading","disabled"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[O,t.config]])]),_:1}),l(h,{class:"box-card"},{header:o(()=>[c("div",_e,[e[16]||(e[16]=c("span",null,"额外出站",-1)),l(f,{type:"primary",onClick:Y,loading:t.extraOutbounds},{default:o(()=>[l(i,null,{default:o(()=>[l(_(re))]),_:1}),b(" "+E(t.extraOutbounds?"保存中...":"保存"),1)]),_:1},8,["loading"])])]),default:o(()=>[B(c("div",ge,null,512),[[O,t.config]])]),_:1}),l(J,{modelValue:s.visible,"onUpdate:modelValue":e[3]||(e[3]=r=>s.visible=r),title:s.isEdit?"编辑订阅":"添加订阅",width:"500px","close-on-click-modal":!1},{footer:o(()=>[l(f,{onClick:e[2]||(e[2]=r=>s.visible=!1),disabled:t.subscription},{default:o(()=>e[17]||(e[17]=[b(" 取消 ")])),_:1,__:[17]},8,["disabled"]),l(f,{type:"primary",onClick:H,loading:t.subscription},{default:o(()=>[b(E(t.subscription?"保存中...":"确定"),1)]),_:1},8,["loading"])]),default:o(()=>[l(D,{model:s.form,"label-width":"100px"},{default:o(()=>[l(p,{label:"名称",required:""},{default:o(()=>[l(x,{modelValue:s.form.name,"onUpdate:modelValue":e[0]||(e[0]=r=>s.form.name=r),placeholder:"请输入订阅名称",disabled:t.subscription},null,8,["modelValue","disabled"])]),_:1}),l(p,{label:"URL",required:""},{default:o(()=>[l(x,{modelValue:s.form.url,"onUpdate:modelValue":e[1]||(e[1]=r=>s.form.url=r),placeholder:"请输入订阅地址",disabled:t.subscription},null,8,["modelValue","disabled"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(J,{modelValue:n.visible,"onUpdate:modelValue":e[11]||(e[11]=r=>n.visible=r),title:n.isEdit?"编辑过滤器":"添加过滤器",width:"500px","close-on-click-modal":!1},{footer:o(()=>[c("span",ve,[l(f,{onClick:e[10]||(e[10]=r=>n.visible=!1),disabled:t.filter},{default:o(()=>e[18]||(e[18]=[b(" 取消 ")])),_:1,__:[18]},8,["disabled"]),l(f,{type:"primary",onClick:X,loading:t.filter},{default:o(()=>[b(E(t.filter?"保存中...":"确定"),1)]),_:1},8,["loading"])])]),default:o(()=>[l(D,{model:n.form,"label-width":"100px"},{default:o(()=>[l(p,{label:"名称",required:""},{default:o(()=>[l(x,{modelValue:n.form.name,"onUpdate:modelValue":e[4]||(e[4]=r=>n.form.name=r),disabled:t.filter},null,8,["modelValue","disabled"])]),_:1}),l(p,{label:"包含关键字"},{default:o(()=>[l(x,{modelValue:n.form.include,"onUpdate:modelValue":e[5]||(e[5]=r=>n.form.include=r),disabled:t.filter},null,8,["modelValue","disabled"])]),_:1}),l(p,{label:"排除关键字"},{default:o(()=>[l(x,{modelValue:n.form.exclude,"onUpdate:modelValue":e[6]||(e[6]=r=>n.form.exclude=r),disabled:t.filter},null,8,["modelValue","disabled"])]),_:1}),l(p,{label:"全部节点"},{default:o(()=>[l(ee,{modelValue:n.form.allNodes,"onUpdate:modelValue":e[7]||(e[7]=r=>n.form.allNodes=r),disabled:t.filter},null,8,["modelValue","disabled"])]),_:1}),n.form.allNodes?ne("",!0):(y(),V(p,{key:0,label:"节点"},{default:o(()=>[l(P,{modelValue:n.form.node,"onUpdate:modelValue":e[8]||(e[8]=r=>n.form.node=r),placeholder:"请选择节点",disabled:t.filter},{default:o(()=>[(y(!0),se(de,null,ie(L.value,r=>(y(),V(C,{key:r.value,label:r.label,value:r.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})),l(p,{label:"模式",required:""},{default:o(()=>[l(P,{modelValue:n.form.mode,"onUpdate:modelValue":e[9]||(e[9]=r=>n.form.mode=r),disabled:t.filter},{default:o(()=>[l(C,{label:"节点选择",value:"select"}),l(C,{label:"速度测试",value:"urltest"})]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])]),_:1})}}},he=ue(ye,[["__scopeId","data-v-c8331095"]]);export{he as default};
