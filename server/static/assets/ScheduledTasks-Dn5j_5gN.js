import{r as f,k as P,n as p,o as c,w as n,E as v,f as i,b as r,e as l,y as m,c as N,F as W,p as g,i as x,z as D,A as E,t as R}from"./index-CTVkQrMm.js";import{P as F}from"./PageContainer-2AeyfqXh.js";import{_ as M}from"./_plugin-vue_export-helper-DlAUqK2U.js";const z={class:"scheduled-tasks"},A={class:"card-header"},I={class:"header-actions"},J={class:"card-header"},L={class:"header-actions"},q={class:"actions"},G={__name:"ScheduledTasks",setup(K){const y=f(!1),w=f(!1),u=f({enabled:!0,schedule:{type:"daily",time:new Date(2e3,0,1,3,0),dayOfWeek:"1",minute:0,cron:"0 3 * * *"}}),s=f({enabled:!0,schedule:{type:"weekly",time:new Date(2e3,0,1,4,0),dayOfWeek:"1",minute:0,cron:"0 4 * * 1"}}),b=f(!1),h=f(!1),j=async()=>{try{w.value=!0;const e=await(await fetch("/api/tasks")).json();if(e.success){if(e.tasks.subscription){const o=e.tasks.subscription;u.value={...o,schedule:{...o.schedule,time:o.schedule.time?new Date(`2000-01-01T${o.schedule.time}`):null}}}if(e.tasks.singbox){const o=e.tasks.singbox;s.value={...o,schedule:{...o.schedule,time:o.schedule.time?new Date(`2000-01-01T${o.schedule.time}`):null}}}}}catch(d){console.error("获取任务配置失败:",d),v.error("获取任务配置失败")}finally{w.value=!1}},B=async()=>{try{y.value=!0;const d={subscription:{...u.value,schedule:{...u.value.schedule,time:u.value.schedule.time?u.value.schedule.time.toTimeString().slice(0,5):null}},singbox:{...s.value,schedule:{...s.value.schedule,time:s.value.schedule.time?s.value.schedule.time.toTimeString().slice(0,5):null}}},o=await(await fetch("/api/tasks",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)})).json();o.success?v.success("保存成功"):v.error(o.error||"保存失败")}catch(d){console.error("保存任务配置失败:",d),v.error("保存任务配置失败")}finally{y.value=!1}},U=async d=>{try{if(d==="subscription"&&b.value||d==="singbox"&&h.value)return;d==="subscription"?b.value=!0:h.value=!0;const o=await(await fetch(`/api/tasks/run/${d}`,{method:"POST"})).json();o.success?v.success("任务执行成功"):v.error(o.error||"任务执行失败")}catch(e){console.error(`执行${d}任务失败:`,e),v.error(`执行任务失败: ${e.message}`)}finally{d==="subscription"?b.value=!1:h.value=!1}};return P(()=>{j()}),(d,e)=>{const o=i("el-icon"),_=i("el-button"),C=i("el-switch"),t=i("el-option"),V=i("el-select"),S=i("el-input"),k=i("el-time-picker"),T=i("el-input-number"),O=i("el-form-item"),H=i("el-form"),$=i("el-card");return c(),p(F,null,{default:n(()=>[r("div",z,[e[20]||(e[20]=r("div",{class:"page-header"},[r("h2",{class:"page-title"},"定时任务")],-1)),l($,{class:"box-card"},{header:n(()=>[r("div",A,[e[17]||(e[17]=r("span",null,"订阅更新",-1)),r("div",I,[l(_,{type:"primary",onClick:e[0]||(e[0]=a=>U("subscription")),loading:b.value},{default:n(()=>[l(o,null,{default:n(()=>[l(x(D))]),_:1}),e[16]||(e[16]=g(" 立即运行 "))]),_:1,__:[16]},8,["loading"]),l(C,{modelValue:u.value.enabled,"onUpdate:modelValue":e[1]||(e[1]=a=>u.value.enabled=a),"active-value":!0,"inactive-value":!1,"inline-prompt":"","active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])])])]),default:n(()=>[l(H,{model:u.value,"label-width":"120px"},{default:n(()=>[l(O,{label:"执行周期"},{default:n(()=>[l(V,{modelValue:u.value.schedule.type,"onUpdate:modelValue":e[2]||(e[2]=a=>u.value.schedule.type=a),class:"schedule-type"},{default:n(()=>[l(t,{label:"每小时",value:"hourly"}),l(t,{label:"每天",value:"daily"}),l(t,{label:"每周",value:"weekly"}),l(t,{label:"自定义",value:"custom"})]),_:1},8,["modelValue"]),u.value.schedule.type==="custom"?(c(),p(S,{key:0,modelValue:u.value.schedule.cron,"onUpdate:modelValue":e[3]||(e[3]=a=>u.value.schedule.cron=a),placeholder:"Cron 表达式 (例如: 0 0 * * *)",class:"cron-input"},null,8,["modelValue"])):m("",!0),u.value.schedule.type==="daily"?(c(),p(k,{key:1,modelValue:u.value.schedule.time,"onUpdate:modelValue":e[4]||(e[4]=a=>u.value.schedule.time=a),format:"HH:mm",placeholder:"选择时间",class:"time-picker"},null,8,["modelValue"])):m("",!0),u.value.schedule.type==="weekly"?(c(),N(W,{key:2},[l(V,{modelValue:u.value.schedule.dayOfWeek,"onUpdate:modelValue":e[5]||(e[5]=a=>u.value.schedule.dayOfWeek=a),class:"day-select"},{default:n(()=>[l(t,{label:"周一",value:"1"}),l(t,{label:"周二",value:"2"}),l(t,{label:"周三",value:"3"}),l(t,{label:"周四",value:"4"}),l(t,{label:"周五",value:"5"}),l(t,{label:"周六",value:"6"}),l(t,{label:"周日",value:"0"})]),_:1},8,["modelValue"]),l(k,{modelValue:u.value.schedule.time,"onUpdate:modelValue":e[6]||(e[6]=a=>u.value.schedule.time=a),format:"HH:mm",placeholder:"选择时间",class:"time-picker"},null,8,["modelValue"])],64)):m("",!0),u.value.schedule.type==="hourly"?(c(),p(T,{key:3,modelValue:u.value.schedule.minute,"onUpdate:modelValue":e[7]||(e[7]=a=>u.value.schedule.minute=a),min:0,max:59,placeholder:"分钟",class:"minute-input"},null,8,["modelValue"])):m("",!0)]),_:1})]),_:1},8,["model"])]),_:1}),l($,{class:"box-card"},{header:n(()=>[r("div",J,[e[19]||(e[19]=r("span",null,"Singbox 内核更新",-1)),r("div",L,[l(_,{type:"primary",onClick:e[8]||(e[8]=a=>U("singbox")),loading:h.value},{default:n(()=>[l(o,null,{default:n(()=>[l(x(D))]),_:1}),e[18]||(e[18]=g(" 立即运行 "))]),_:1,__:[18]},8,["loading"]),l(C,{modelValue:s.value.enabled,"onUpdate:modelValue":e[9]||(e[9]=a=>s.value.enabled=a),"active-value":!0,"inactive-value":!1,"inline-prompt":"","active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])])])]),default:n(()=>[l(H,{model:s.value,"label-width":"120px"},{default:n(()=>[l(O,{label:"执行周期"},{default:n(()=>[l(V,{modelValue:s.value.schedule.type,"onUpdate:modelValue":e[10]||(e[10]=a=>s.value.schedule.type=a),class:"schedule-type"},{default:n(()=>[l(t,{label:"每小时",value:"hourly"}),l(t,{label:"每天",value:"daily"}),l(t,{label:"每周",value:"weekly"}),l(t,{label:"自定义",value:"custom"})]),_:1},8,["modelValue"]),s.value.schedule.type==="custom"?(c(),p(S,{key:0,modelValue:s.value.schedule.cron,"onUpdate:modelValue":e[11]||(e[11]=a=>s.value.schedule.cron=a),placeholder:"Cron 表达式 (例如: 0 0 * * *)",class:"cron-input"},null,8,["modelValue"])):m("",!0),s.value.schedule.type==="daily"?(c(),p(k,{key:1,modelValue:s.value.schedule.time,"onUpdate:modelValue":e[12]||(e[12]=a=>s.value.schedule.time=a),format:"HH:mm",placeholder:"选择时间",class:"time-picker"},null,8,["modelValue"])):m("",!0),s.value.schedule.type==="weekly"?(c(),N(W,{key:2},[l(V,{modelValue:s.value.schedule.dayOfWeek,"onUpdate:modelValue":e[13]||(e[13]=a=>s.value.schedule.dayOfWeek=a),class:"day-select"},{default:n(()=>[l(t,{label:"周一",value:"1"}),l(t,{label:"周二",value:"2"}),l(t,{label:"周三",value:"3"}),l(t,{label:"周四",value:"4"}),l(t,{label:"周五",value:"5"}),l(t,{label:"周六",value:"6"}),l(t,{label:"周日",value:"0"})]),_:1},8,["modelValue"]),l(k,{modelValue:s.value.schedule.time,"onUpdate:modelValue":e[14]||(e[14]=a=>s.value.schedule.time=a),format:"HH:mm",placeholder:"选择时间",class:"time-picker"},null,8,["modelValue"])],64)):m("",!0),s.value.schedule.type==="hourly"?(c(),p(T,{key:3,modelValue:s.value.schedule.minute,"onUpdate:modelValue":e[15]||(e[15]=a=>s.value.schedule.minute=a),min:0,max:59,placeholder:"分钟",class:"minute-input"},null,8,["modelValue"])):m("",!0)]),_:1})]),_:1},8,["model"])]),_:1}),r("div",q,[l(_,{type:"primary",onClick:B,loading:y.value},{default:n(()=>[l(o,null,{default:n(()=>[l(x(E))]),_:1}),g(" "+R(y.value?"保存中...":"保存配置"),1)]),_:1},8,["loading"])])])]),_:1})}}},Z=M(G,[["__scopeId","data-v-bbc9aeee"]]);export{Z as default};
