import{r as h,a as B,B as ae,k as re,m as ne,n as x,o as g,w as t,E as d,f,C as se,b as u,e as l,D as N,i as v,G as P,H as F,p as _,I,t as k,A as de,y as L,c as R,F as q,J as ie,K as M}from"./index-EJWQmZrC.js";import{P as ue}from"./PageContainer-ChjlHtAI.js";import"./globalConfig-icp6RQy6.js";import{J as fe}from"./jsoneditor-olEp2avP.js";import{_ as me}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ce={class:"outbound"},pe={class:"card-header"},be={class:"card-header"},_e={class:"card-header"},ge={id:"extraOutboundsEditor",style:{width:"100%",height:"400px"}},ve={class:"dialog-footer"},V="/api",ye={__name:"Outbound",setup(we){const y=h(null),o=B({config:!1,subscription:!1,filter:!1,extraOutbounds:!1,delete:!1}),E=h([]),$=h([]),s=B({visible:!1,isEdit:!1,form:{name:"",url:"",lastUpdate:""}}),r=B({visible:!1,isEdit:!1,form:{name:"",include:"",exclude:"",allNodes:!0,node:"",mode:"select",url:"",interval:"",idle_timeout:""}}),G=ae(()=>E.value.map(n=>({label:n.name,value:n.name}))),H=()=>{const n=document.getElementById("extraOutboundsEditor"),e={mode:"code",modes:["code","tree","view","form","text"],onError:function(i){d.error("JSON 格式错误："+i.toString())},mainMenuBar:!0,navigationBar:!1,statusBar:!0,colorPicker:!1,search:!0,format:!0,repair:!0};y.value=new fe(n,e)},w=async()=>{try{o.config=!0;const n=await fetch(`${V}/config`);if(n.ok){const e=await n.json();if(E.value=e.subscribe.subscriptions||[],$.value=e.subscribe.filters||[],y.value){const i=e.subscribe.ex_outbounds||[];y.value.set(i)}}else d.error("加载配置失败")}catch(n){console.error("加载配置失败:",n),d.error("加载配置失败，请检查后端服务是否启动")}finally{o.config=!1}},K=()=>{s.visible=!0,s.isEdit=!1,s.form={name:"",url:"",lastUpdate:""}},z=n=>{s.visible=!0,s.isEdit=!0,s.form={name:n.name,url:n.url,lastUpdate:n.lastUpdate}},Q=async n=>{try{await M.confirm("确定要删除该订阅吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),o.delete=!0;const e=await fetch(`${V}/subscription/${encodeURIComponent(n.name)}`,{method:"DELETE"});if(e.ok)d.success("删除成功"),await w();else{const i=await e.json();d.error(i.error||"删除失败")}}catch(e){e!=="cancel"&&(console.error("删除订阅失败:",e),d.error("删除失败"))}finally{o.delete=!1}},W=async()=>{if(!s.form.name||!s.form.url){d.warning("请填写名称和URL");return}try{o.subscription=!0;const n=await fetch(`${V}/subscription`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s.form.name,url:s.form.url,lastUpdate:s.form.lastUpdate})});if(n.ok)d.success(s.isEdit?"编辑成功":"添加成功"),s.visible=!1,await w();else{const e=await n.json();d.error(e.error||"保存失败")}}catch(n){console.error("保存订阅失败:",n),d.error("保存失败")}finally{o.subscription=!1}},X=()=>{r.visible=!0,r.isEdit=!1,r.form={name:"",include:"",exclude:"",allNodes:!0,node:"",mode:"select",url:"",interval:"",idle_timeout:""}},Y=n=>{r.visible=!0,r.isEdit=!0,r.form={...n}},Z=async n=>{try{await M.confirm("确定要删除该过滤器吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),o.delete=!0;const e=await fetch(`${V}/filter/${encodeURIComponent(n.name)}`,{method:"DELETE"});if(e.ok)d.success("删除成功"),await w();else{const i=await e.json();d.error(i.error||"删除失败")}}catch(e){e!=="cancel"&&(console.error("删除过滤器失败:",e),d.error("删除失败"))}finally{o.delete=!1}},ee=async()=>{if(!r.form.name||!r.form.mode){d.warning("请填写名称和模式");return}if(!r.form.allNodes&&!r.form.node){d.warning("请选择节点");return}try{o.filter=!0,console.log("正在保存过滤器:",r.form);const n=await fetch(`${V}/filter`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r.form)}),e=await n.json();n.ok?(d.success(r.isEdit?"编辑成功":"添加成功"),r.visible=!1,await w()):(console.error("保存过滤器失败:",e),d.error(e.error||"保存失败"))}catch(n){console.error("保存过滤器异常:",n),d.error(`保存失败: ${n.message}`)}finally{o.filter=!1}},le=async()=>{try{o.extraOutbounds=!0;const n=y.value.get();if(!Array.isArray(n)){d.error("额外出站必须是一个 JSON 数组");return}const e=await fetch(`${V}/extra-outbounds`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(e.ok)d.success("额外出站配置保存成功"),await w();else{const i=await e.json();d.error(i.error||"保存失败")}}catch(n){console.error("保存额外出站配置失败:",n),d.error("保存失败，请检查后端服务是否启动")}finally{o.extraOutbounds=!1}};return re(()=>{H(),setTimeout(()=>{w()},100)}),ne(()=>{y.value&&y.value.destroy()}),(n,e)=>{const i=f("el-icon"),m=f("el-button"),p=f("el-table-column"),T=f("el-button-group"),D=f("el-table"),C=f("el-card"),te=f("el-tag"),b=f("el-input"),c=f("el-form-item"),j=f("el-form"),J=f("el-dialog"),oe=f("el-switch"),U=f("el-option"),A=f("el-select"),O=se("loading");return g(),x(ue,null,{default:t(()=>[u("div",ce,[e[26]||(e[26]=u("div",{class:"page-header"},[u("h2",{class:"page-title"},"出站配置")],-1)),l(C,{class:"box-card"},{header:t(()=>[u("div",pe,[e[16]||(e[16]=u("span",null,"订阅",-1)),l(m,{type:"primary",onClick:K,loading:o.subscription},{default:t(()=>[l(i,null,{default:t(()=>[l(v(I))]),_:1}),e[15]||(e[15]=_(" 添加订阅 "))]),_:1,__:[15]},8,["loading"])])]),default:t(()=>[N((g(),x(D,{data:E.value,style:{width:"100%"}},{default:t(()=>[l(p,{prop:"name",label:"名称"}),l(p,{prop:"url",label:"链接","show-overflow-tooltip":""}),l(p,{label:"操作",width:"200"},{default:t(({row:a})=>[l(T,null,{default:t(()=>[l(m,{type:"primary",onClick:S=>z(a),loading:o.subscription,disabled:o.subscription},{default:t(()=>[l(i,null,{default:t(()=>[l(v(P))]),_:1})]),_:2},1032,["onClick","loading","disabled"]),l(m,{type:"danger",onClick:S=>Q(a),loading:o.delete,disabled:o.delete},{default:t(()=>[l(i,null,{default:t(()=>[l(v(F))]),_:1})]),_:2},1032,["onClick","loading","disabled"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[O,o.config]])]),_:1}),l(C,{class:"box-card"},{header:t(()=>[u("div",be,[e[18]||(e[18]=u("span",null,"过滤器",-1)),l(m,{type:"primary",onClick:X,loading:o.filter},{default:t(()=>[l(i,null,{default:t(()=>[l(v(I))]),_:1}),e[17]||(e[17]=_(" 添加过滤器 "))]),_:1,__:[17]},8,["loading"])])]),default:t(()=>[N((g(),x(D,{data:$.value,style:{width:"100%"}},{default:t(()=>[l(p,{prop:"name",label:"名称"}),l(p,{prop:"include",label:"包含关键字","show-overflow-tooltip":""}),l(p,{prop:"exclude",label:"排除关键字","show-overflow-tooltip":""}),l(p,{prop:"mode",label:"模式"},{default:t(({row:a})=>[l(te,{type:a.mode==="select"?"success":"warning"},{default:t(()=>[_(k(a.mode==="select"?"节点选择":"速度测试"),1)]),_:2},1032,["type"])]),_:1}),l(p,{label:"操作",width:"200"},{default:t(({row:a})=>[l(T,null,{default:t(()=>[l(m,{type:"primary",onClick:S=>Y(a),loading:o.filter,disabled:o.filter},{default:t(()=>[l(i,null,{default:t(()=>[l(v(P))]),_:1})]),_:2},1032,["onClick","loading","disabled"]),l(m,{type:"danger",onClick:S=>Z(a),loading:o.delete,disabled:o.delete},{default:t(()=>[l(i,null,{default:t(()=>[l(v(F))]),_:1})]),_:2},1032,["onClick","loading","disabled"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[O,o.config]])]),_:1}),l(C,{class:"box-card"},{header:t(()=>[u("div",_e,[e[19]||(e[19]=u("span",null,"额外出站",-1)),l(m,{type:"primary",onClick:le,loading:o.extraOutbounds},{default:t(()=>[l(i,null,{default:t(()=>[l(v(de))]),_:1}),_(" "+k(o.extraOutbounds?"保存中...":"保存"),1)]),_:1},8,["loading"])])]),default:t(()=>[N(u("div",ge,null,512),[[O,o.config]])]),_:1}),l(J,{modelValue:s.visible,"onUpdate:modelValue":e[3]||(e[3]=a=>s.visible=a),title:s.isEdit?"编辑订阅":"添加订阅",width:"500px","close-on-click-modal":!1},{footer:t(()=>[l(m,{onClick:e[2]||(e[2]=a=>s.visible=!1),disabled:o.subscription},{default:t(()=>e[21]||(e[21]=[_(" 取消 ")])),_:1,__:[21]},8,["disabled"]),l(m,{type:"primary",onClick:W,loading:o.subscription},{default:t(()=>[_(k(o.subscription?"保存中...":"确定"),1)]),_:1},8,["loading"])]),default:t(()=>[l(j,{model:s.form,"label-width":"100px"},{default:t(()=>[l(c,{label:"名称",required:""},{default:t(()=>[l(b,{modelValue:s.form.name,"onUpdate:modelValue":e[0]||(e[0]=a=>s.form.name=a),placeholder:"请输入订阅名称",disabled:o.subscription},null,8,["modelValue","disabled"])]),_:1}),l(c,{label:"URL",required:""},{default:t(()=>[l(b,{modelValue:s.form.url,"onUpdate:modelValue":e[1]||(e[1]=a=>s.form.url=a),placeholder:"请输入订阅地址",disabled:o.subscription},null,8,["modelValue","disabled"]),e[20]||(e[20]=u("div",{class:"form-item-tip"},"请填写singbox格式的订阅链接，推荐使用substore进行订阅转换",-1))]),_:1,__:[20]})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(J,{modelValue:r.visible,"onUpdate:modelValue":e[14]||(e[14]=a=>r.visible=a),title:r.isEdit?"编辑过滤器":"添加过滤器",width:"500px","close-on-click-modal":!1},{footer:t(()=>[u("span",ve,[l(m,{onClick:e[13]||(e[13]=a=>r.visible=!1),disabled:o.filter},{default:t(()=>e[25]||(e[25]=[_(" 取消 ")])),_:1,__:[25]},8,["disabled"]),l(m,{type:"primary",onClick:ee,loading:o.filter},{default:t(()=>[_(k(o.filter?"保存中...":"确定"),1)]),_:1},8,["loading"])])]),default:t(()=>[l(j,{model:r.form,"label-width":"100px"},{default:t(()=>[l(c,{label:"名称",required:""},{default:t(()=>[l(b,{modelValue:r.form.name,"onUpdate:modelValue":e[4]||(e[4]=a=>r.form.name=a),disabled:o.filter},null,8,["modelValue","disabled"])]),_:1}),l(c,{label:"包含关键字"},{default:t(()=>[l(b,{modelValue:r.form.include,"onUpdate:modelValue":e[5]||(e[5]=a=>r.form.include=a),disabled:o.filter},null,8,["modelValue","disabled"])]),_:1}),l(c,{label:"排除关键字"},{default:t(()=>[l(b,{modelValue:r.form.exclude,"onUpdate:modelValue":e[6]||(e[6]=a=>r.form.exclude=a),disabled:o.filter},null,8,["modelValue","disabled"])]),_:1}),l(c,{label:"全部节点"},{default:t(()=>[l(oe,{modelValue:r.form.allNodes,"onUpdate:modelValue":e[7]||(e[7]=a=>r.form.allNodes=a),disabled:o.filter},null,8,["modelValue","disabled"])]),_:1}),r.form.allNodes?L("",!0):(g(),x(c,{key:0,label:"节点"},{default:t(()=>[l(A,{modelValue:r.form.node,"onUpdate:modelValue":e[8]||(e[8]=a=>r.form.node=a),placeholder:"请选择节点",disabled:o.filter},{default:t(()=>[(g(!0),R(q,null,ie(G.value,a=>(g(),x(U,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})),l(c,{label:"模式",required:""},{default:t(()=>[l(A,{modelValue:r.form.mode,"onUpdate:modelValue":e[9]||(e[9]=a=>r.form.mode=a),disabled:o.filter},{default:t(()=>[l(U,{label:"节点选择",value:"select"}),l(U,{label:"速度测试",value:"urltest"})]),_:1},8,["modelValue","disabled"])]),_:1}),r.form.mode==="urltest"?(g(),R(q,{key:1},[l(c,{label:"测试URL"},{default:t(()=>[l(b,{modelValue:r.form.url,"onUpdate:modelValue":e[10]||(e[10]=a=>r.form.url=a),placeholder:"https://www.gstatic.com/generate_204",disabled:o.filter},null,8,["modelValue","disabled"]),e[22]||(e[22]=u("div",{class:"form-item-tip"},"用于测试的链接。默认使用 https://www.gstatic.com/generate_204",-1))]),_:1,__:[22]}),l(c,{label:"测试间隔"},{default:t(()=>[l(b,{modelValue:r.form.interval,"onUpdate:modelValue":e[11]||(e[11]=a=>r.form.interval=a),placeholder:"3m",disabled:o.filter},null,8,["modelValue","disabled"]),e[23]||(e[23]=u("div",{class:"form-item-tip"},"测试间隔。默认使用 3m",-1))]),_:1,__:[23]}),l(c,{label:"空闲超时"},{default:t(()=>[l(b,{modelValue:r.form.idle_timeout,"onUpdate:modelValue":e[12]||(e[12]=a=>r.form.idle_timeout=a),placeholder:"30m",disabled:o.filter},null,8,["modelValue","disabled"]),e[24]||(e[24]=u("div",{class:"form-item-tip"},"空闲超时。默认使用 30m",-1))]),_:1,__:[24]})],64)):L("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])]),_:1})}}},Ue=me(ye,[["__scopeId","data-v-77378c77"]]);export{Ue as default};
