import{r as f,o as P,c as p,b as c,w as n,E as v,d as i,e as r,f as l,h as m,i as N,F as W,g,u as x,v as j,j as E,t as R}from"./index-D0h7X9x_.js";import{_ as F,P as M}from"./PageContainer-BIDKZJWI.js";const I={class:"scheduled-tasks"},J={class:"card-header"},L={class:"header-actions"},q={class:"card-header"},z={class:"header-actions"},A={class:"actions"},G={__name:"ScheduledTasks",setup(K){const h=f(!1),w=f(!1),t=f({enabled:!0,schedule:{type:"daily",time:new Date(2e3,0,1,3,0),dayOfWeek:"1",minute:0,cron:"0 3 * * *"}}),u=f({enabled:!0,schedule:{type:"weekly",time:new Date(2e3,0,1,4,0),dayOfWeek:"1",minute:0,cron:"0 4 * * 1"}}),y=f(!1),b=f(!1),D=async()=>{try{w.value=!0;const e=await(await fetch("/api/tasks")).json();if(e.success){if(e.tasks.subscription){const o=e.tasks.subscription;t.value={...o,schedule:{...o.schedule,time:o.schedule.time?new Date(`2000-01-01T${o.schedule.time}`):null}}}if(e.tasks.singbox){const o=e.tasks.singbox;u.value={...o,schedule:{...o.schedule,time:o.schedule.time?new Date(`2000-01-01T${o.schedule.time}`):null}}}}}catch(d){console.error("获取任务配置失败:",d),v.error("获取任务配置失败")}finally{w.value=!1}},B=async()=>{try{h.value=!0;const d={subscription:{...t.value,schedule:{...t.value.schedule,time:t.value.schedule.time?t.value.schedule.time.toTimeString().slice(0,5):null}},singbox:{...u.value,schedule:{...u.value.schedule,time:u.value.schedule.time?u.value.schedule.time.toTimeString().slice(0,5):null}}},o=await(await fetch("http://localhost:3001/api/tasks",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)})).json();o.success?v.success("保存成功"):v.error(o.error||"保存失败")}catch(d){console.error("保存任务配置失败:",d),v.error("保存任务配置失败")}finally{h.value=!1}},U=async d=>{try{if(d==="subscription"&&y.value||d==="singbox"&&b.value)return;d==="subscription"?y.value=!0:b.value=!0;const o=await(await fetch(`http://localhost:3001/api/tasks/run/${d}`,{method:"POST"})).json();o.success?v.success("任务执行成功"):v.error(o.error||"任务执行失败")}catch(e){console.error(`执行${d}任务失败:`,e),v.error(`执行任务失败: ${e.message}`)}finally{d==="subscription"?y.value=!1:b.value=!1}};return P(()=>{D()}),(d,e)=>{const o=i("el-icon"),_=i("el-button"),C=i("el-switch"),s=i("el-option"),V=i("el-select"),S=i("el-input"),k=i("el-time-picker"),T=i("el-input-number"),O=i("el-form-item"),H=i("el-form"),$=i("el-card");return c(),p(M,null,{default:n(()=>[r("div",I,[e[20]||(e[20]=r("div",{class:"page-header"},[r("h2",{class:"page-title"},"定时任务")],-1)),l($,{class:"box-card"},{header:n(()=>[r("div",J,[e[17]||(e[17]=r("span",null,"订阅更新",-1)),r("div",L,[l(_,{type:"primary",onClick:e[0]||(e[0]=a=>U("subscription")),loading:y.value},{default:n(()=>[l(o,null,{default:n(()=>[l(x(j))]),_:1}),e[16]||(e[16]=g(" 立即运行 "))]),_:1,__:[16]},8,["loading"]),l(C,{modelValue:t.value.enabled,"onUpdate:modelValue":e[1]||(e[1]=a=>t.value.enabled=a),"active-value":!0,"inactive-value":!1,"inline-prompt":"","active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])])])]),default:n(()=>[l(H,{model:t.value,"label-width":"120px"},{default:n(()=>[l(O,{label:"执行周期"},{default:n(()=>[l(V,{modelValue:t.value.schedule.type,"onUpdate:modelValue":e[2]||(e[2]=a=>t.value.schedule.type=a),class:"schedule-type"},{default:n(()=>[l(s,{label:"每小时",value:"hourly"}),l(s,{label:"每天",value:"daily"}),l(s,{label:"每周",value:"weekly"}),l(s,{label:"自定义",value:"custom"})]),_:1},8,["modelValue"]),t.value.schedule.type==="custom"?(c(),p(S,{key:0,modelValue:t.value.schedule.cron,"onUpdate:modelValue":e[3]||(e[3]=a=>t.value.schedule.cron=a),placeholder:"Cron 表达式 (例如: 0 0 * * *)",class:"cron-input"},null,8,["modelValue"])):m("",!0),t.value.schedule.type==="daily"?(c(),p(k,{key:1,modelValue:t.value.schedule.time,"onUpdate:modelValue":e[4]||(e[4]=a=>t.value.schedule.time=a),format:"HH:mm",placeholder:"选择时间",class:"time-picker"},null,8,["modelValue"])):m("",!0),t.value.schedule.type==="weekly"?(c(),N(W,{key:2},[l(V,{modelValue:t.value.schedule.dayOfWeek,"onUpdate:modelValue":e[5]||(e[5]=a=>t.value.schedule.dayOfWeek=a),class:"day-select"},{default:n(()=>[l(s,{label:"周一",value:"1"}),l(s,{label:"周二",value:"2"}),l(s,{label:"周三",value:"3"}),l(s,{label:"周四",value:"4"}),l(s,{label:"周五",value:"5"}),l(s,{label:"周六",value:"6"}),l(s,{label:"周日",value:"0"})]),_:1},8,["modelValue"]),l(k,{modelValue:t.value.schedule.time,"onUpdate:modelValue":e[6]||(e[6]=a=>t.value.schedule.time=a),format:"HH:mm",placeholder:"选择时间",class:"time-picker"},null,8,["modelValue"])],64)):m("",!0),t.value.schedule.type==="hourly"?(c(),p(T,{key:3,modelValue:t.value.schedule.minute,"onUpdate:modelValue":e[7]||(e[7]=a=>t.value.schedule.minute=a),min:0,max:59,placeholder:"分钟",class:"minute-input"},null,8,["modelValue"])):m("",!0)]),_:1})]),_:1},8,["model"])]),_:1}),l($,{class:"box-card"},{header:n(()=>[r("div",q,[e[19]||(e[19]=r("span",null,"Singbox 内核更新",-1)),r("div",z,[l(_,{type:"primary",onClick:e[8]||(e[8]=a=>U("singbox")),loading:b.value},{default:n(()=>[l(o,null,{default:n(()=>[l(x(j))]),_:1}),e[18]||(e[18]=g(" 立即运行 "))]),_:1,__:[18]},8,["loading"]),l(C,{modelValue:u.value.enabled,"onUpdate:modelValue":e[9]||(e[9]=a=>u.value.enabled=a),"active-value":!0,"inactive-value":!1,"inline-prompt":"","active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])])])]),default:n(()=>[l(H,{model:u.value,"label-width":"120px"},{default:n(()=>[l(O,{label:"执行周期"},{default:n(()=>[l(V,{modelValue:u.value.schedule.type,"onUpdate:modelValue":e[10]||(e[10]=a=>u.value.schedule.type=a),class:"schedule-type"},{default:n(()=>[l(s,{label:"每小时",value:"hourly"}),l(s,{label:"每天",value:"daily"}),l(s,{label:"每周",value:"weekly"}),l(s,{label:"自定义",value:"custom"})]),_:1},8,["modelValue"]),u.value.schedule.type==="custom"?(c(),p(S,{key:0,modelValue:u.value.schedule.cron,"onUpdate:modelValue":e[11]||(e[11]=a=>u.value.schedule.cron=a),placeholder:"Cron 表达式 (例如: 0 0 * * *)",class:"cron-input"},null,8,["modelValue"])):m("",!0),u.value.schedule.type==="daily"?(c(),p(k,{key:1,modelValue:u.value.schedule.time,"onUpdate:modelValue":e[12]||(e[12]=a=>u.value.schedule.time=a),format:"HH:mm",placeholder:"选择时间",class:"time-picker"},null,8,["modelValue"])):m("",!0),u.value.schedule.type==="weekly"?(c(),N(W,{key:2},[l(V,{modelValue:u.value.schedule.dayOfWeek,"onUpdate:modelValue":e[13]||(e[13]=a=>u.value.schedule.dayOfWeek=a),class:"day-select"},{default:n(()=>[l(s,{label:"周一",value:"1"}),l(s,{label:"周二",value:"2"}),l(s,{label:"周三",value:"3"}),l(s,{label:"周四",value:"4"}),l(s,{label:"周五",value:"5"}),l(s,{label:"周六",value:"6"}),l(s,{label:"周日",value:"0"})]),_:1},8,["modelValue"]),l(k,{modelValue:u.value.schedule.time,"onUpdate:modelValue":e[14]||(e[14]=a=>u.value.schedule.time=a),format:"HH:mm",placeholder:"选择时间",class:"time-picker"},null,8,["modelValue"])],64)):m("",!0),u.value.schedule.type==="hourly"?(c(),p(T,{key:3,modelValue:u.value.schedule.minute,"onUpdate:modelValue":e[15]||(e[15]=a=>u.value.schedule.minute=a),min:0,max:59,placeholder:"分钟",class:"minute-input"},null,8,["modelValue"])):m("",!0)]),_:1})]),_:1},8,["model"])]),_:1}),r("div",A,[l(_,{type:"primary",onClick:B,loading:h.value},{default:n(()=>[l(o,null,{default:n(()=>[l(x(E))]),_:1}),g(" "+R(h.value?"保存中...":"保存配置"),1)]),_:1},8,["loading"])])])]),_:1})}}},Y=F(G,[["__scopeId","data-v-d3fbf045"]]);export{Y as default};
